# Niibot

一個功能豐富的 Discord 機器人，使用 Python 開發，提供完整的伺服器管理和娛樂功能。

## 🎯 主要功能

### 🎭 核心模組
- **回覆系統** (`reply.py`) - 自動回覆、Copycat 用戶資料複製
- **分隊系統** (`party.py`) - 智能分隊、語音頻道管理
- **用餐推薦** (`eat.py`) - 隨機餐點推薦系統
- **抽獎系統** (`draw.py`) - 抽獎活動、隨機選擇器
- **打卡系統** (`clock.py`) - 個人化打卡、時間追蹤
- **表情工具** (`emojitool.py`) - 自訂表情符號管理
- **準心代碼庫** (`repo.py`) - FPS 遊戲準心代碼管理
- **配對遊戲** (`tinder.py`) - 簡單配對功能
- **清理工具** (`clear.py`) - 訊息批量刪除
- **Twitter 監控** (`twitter_monitor.py`) - 自動監控 X 帳號並翻譯貼文

### 🔗 指令系統
- **傳統指令** - 以 `?` 開頭的前綴指令
- **斜線指令** - 以 `/` 開頭的現代 Discord 指令
- **斜線指令列表** - 使用 `/help` 查看所有可用斜線指令

## 🚀 快速開始

### 安裝依賴
```bash
# 生產環境
pip install -r requirements.txt

# 開發環境（包含程式碼品質工具）
pip install -r requirements-dev.txt
```

### 環境配置
複製 `.env.example` 為 `.env` 並填入必要資訊：

```bash
# Discord Bot Token (必要)
TOKEN=your_discord_bot_token_here

# Bot 環境 (local 或 prod)
BOT_ENV=local

# Twitter 監控設定 (可選)
TWITTER_BEARER_TOKEN=your_twitter_bearer_token_here
GOOGLE_TRANSLATE_API_KEY=your_google_translate_api_key_here

# 其他設定
TARGET_ROLE_ID=1378242954929639514
WORK_HOURS=9
DRAW_COOLDOWN=30
LOG_LEVEL=WARNING
```

### 執行機器人
```bash
python bot.py
```

## 🎯 詳細功能說明

### 🎭 Copycat 用戶資料複製
**指令**: `?cc` / `?複製` / `?ditto` / `/copycat`

**功能特色**:
- 🔄 **智能切換** - 伺服器專用設定 ↔ 主要設定
- 🏠 **伺服器優先** - 自動優先顯示 Nitro 用戶的伺服器專用頭像/橫幅
- 🔒 **權限控制** - 只有指令發起者可操作切換按鈕
- 📱 **互動式介面** - 單一按鈕輕鬆切換不同組合
- 🎨 **配對一致** - 頭像和橫幅保持同一來源，避免混搭

**使用方式**:
```bash
?cc @用戶名        # 提及用戶
?cc 用戶ID        # 使用用戶ID
?cc 用戶名稱      # 使用顯示名稱
/copycat [用戶]   # 斜線指令版本
```

### 👥 分隊系統
**指令**: `?queue` / `?q` / `?開隊`

**功能特色**:
- 🎯 **智能分隊** - 多種分隊演算法，支援不同模式
- 🔊 **語音管理** - 動態建立語音頻道，自動移動玩家
- ⏰ **即時監控** - 30秒清理週期，自動清理空頻道
- 🎮 **遊戲整合** - 支援 Board Game Arena、CodeNames、Gartic Phone 等
- 🎪 **持久化佇列** - 使用 Discord Views/Modals 的互動式介面

**權限需求**:
- `manage_channels` - 建立語音頻道
- `move_members` - 移動用戶到語音頻道

### 🕘 個人化打卡系統
**指令**: `/pclock` / `/pstatus` / `/pclock_manual`

**核心特色**:
- ✅ **完全個人化** - 每位用戶獨立設定上班時間和工時
- ⏰ **自動提醒** - 到點自動@用戶並彈出打卡界面
- 🔄 **彈性模式** - 支援彈性打卡時間窗口
- 📊 **精確計算** - 準確的工時統計和遲到判定
- 🎨 **美觀界面** - 統一色彩系統，清晰資訊層次

**快速開始**:
```bash
/pclock          # 初次設定（彈出設定Modal）
/pstatus         # 查看個人工作狀態
/pclock_manual   # 緊急手動打卡
```

**設定參數**:
- **上班時間**: 例如 `08:30`
- **工作時數**: 例如 `8.0`
- **彈性打卡**: `是` 啟用，`否` 關閉
- **彈性時間**: 彈性模式下的時間窗口（分鐘）

### 🐦 Twitter/X 監控系統
**指令**: `/twitter_setup` / `/twitter_status` / `/twitter_toggle`

**核心功能**:
- 🔄 **自動監控** - 定時檢查指定 X 帳號的新貼文
- 🌏 **智能翻譯** - Google Translate API 繁體中文翻譯
- 🖼️ **媒體支援** - 完整抓取圖片、影片預覽
- 🎨 **美觀呈現** - Discord Embed 精美顯示
- 🔒 **去重機制** - 自動避免重複發送

**設定步驟**:
1. **取得 Twitter Bearer Token**:
   - 前往 [Twitter Developer Portal](https://developer.twitter.com/)
   - 申請開發者帳號並建立 App
   - 取得 Bearer Token

2. **設定監控**:
   ```bash
   /twitter_setup username:目標用戶名 channel:#頻道 interval:300
   ```

3. **查看狀態**:
   ```bash
   /twitter_status    # 查看監控狀態
   /twitter_toggle    # 開啟/關閉監控
   ```

**調試工具**:
```bash
/twitter_debug       # 詳細的系統狀態和配置信息
/twitter_test        # 手動測試 API 連接
/twitter_force_check # 強制立即檢查
```

### 🎯 準心代碼庫
**指令**: `?repo` / `?準心`

**功能特色**:
- 🎮 **遊戲分類** - 支援 Valorant、CS2 等遊戲
- 🖼️ **圖片預覽** - 準心截圖直接顯示
- 📋 **代碼管理** - 完整的準心代碼儲存和檢索
- 🔄 **翻頁瀏覽** - 互動式界面，易於瀏覽
- ➕ **管理功能** - 新增、刪除準心代碼

**管理指令**:
```bash
?repo_add        # 新增準心到代碼庫
?repo_del        # 刪除指定ID的準心
```

### 🍽️ 用餐推薦系統
**指令**: `?eat` / `?吃什麼`

**功能特色**:
- 🎲 **隨機推薦** - 從分類中隨機選擇餐點
- 📂 **分類管理** - 支援主餐、點心、飲料等分類
- ➕ **自訂選項** - 可新增、刪除餐點選項
- 📋 **完整管理** - 分類和選項的完整 CRUD 操作

**管理指令**:
```bash
?cat           # 顯示所有分類
?menu 分類     # 顯示分類中的所有選項
?additem 分類 餐點  # 新增餐點到分類
?delitem 分類 餐點  # 從分類中移除餐點
?delcat 分類   # 刪除整個分類
```

### 🎲 抽獎系統
**指令**: `?draw` / `?抽獎` / `?choose` / `?選擇`

**功能特色**:
- 🎯 **多種模式** - 支援一般抽獎和權重選擇
- ⏱️ **冷卻機制** - 防止濫用，可配置冷卻時間
- 📊 **權重支援** - 格式：`選項1*權重1 選項2*權重2`
- 🎪 **互動界面** - 美觀的抽獎結果展示

**使用範例**:
```bash
?draw 選項1 選項2 選項3
?choose 蘋果*3 橘子*1 香蕉*2  # 權重選擇
```

### 😊 表情工具
**指令**: `?emoji_add` / `?emoji_list` / `?keyword_add`

**功能特色**:
- 🎭 **自訂表情** - 建立表情符號對應關係
- 🔑 **關鍵字回覆** - 自動偵測關鍵字並回覆
- 📊 **使用統計** - 追蹤表情符號使用頻率
- 💾 **自動儲存** - 定期儲存統計資料

**管理指令**:
```bash
?emoji_add 名稱 🎉     # 新增表情符號對應
?emoji_list            # 列出所有自訂表情
?keyword_add 你好 嗨   # 新增關鍵字自動回覆
?emoji_help           # 顯示詳細使用說明
```

### 💕 配對遊戲
**指令**: `?tinder` / `?配對` / `?t`

**功能特色**:
- 💝 **匿名配對** - 保護隱私的配對系統
- 💬 **中介聊天** - 機器人代為傳遞訊息
- 🎨 **美觀界面** - 精美的配對結果展示
- 🔒 **隱私保護** - 完整的匿名機制

**使用指令**:
```bash
?tinder              # 開啟配對系統
?chat 訊息內容       # 與配對對象聊天
```

### 🧹 清理工具
**指令**: `?clear` / `?清理`

**功能特色**:
- 📝 **批量刪除** - 指定數量或範圍刪除訊息
- 👤 **用戶過濾** - 只刪除特定用戶的訊息
- ⏰ **時間範圍** - 支援時間範圍內的訊息刪除
- 🔒 **權限控制** - 基於角色的操作權限

**權限需求**:
- `manage_messages` - 刪除他人訊息的權限

## 🏗️ 架構設計

### 配置系統
- **本地開發**: `config_local.py` (使用 .env 檔案)
- **生產環境**: `config_prod.py` (使用環境變數)
- **統一管理**: `utils/config_manager.py` (單例模式)

### 模組化架構
- **動態載入**: 所有 cog 自動從 `cogs/` 目錄載入
- **熱重載**: 支援 `?l`, `?u`, `?rl` 指令動態管理模組
- **事件分發**: 集中式訊息處理系統 (`listener.py`)

### 資料儲存
- **JSON 格式**: `data/` 目錄存放所有配置資料
- **非同步 I/O**: 高效能檔案操作
- **錯誤處理**: 完整的異常處理機制

### 日誌系統
- **多級別輸出**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **集中管理**: `utils/logger.py` 統一日誌處理
- **檔案輸出**: 支援本地開發時的檔案日誌
- **結構化記錄**: JSON 格式日誌支援

## 📊 系統特色

### 🎮 遊戲整合
- **Board Game Arena** - 線上桌遊平台
- **CodeNames** - 代號遊戲詞彙庫
- **Gartic Phone** - 你畫我猜遊戲
- **GeoGuessr** - 地理位置猜測
- **FPS 遊戲** - 準心代碼分享

### 🛠️ 管理工具
- **訊息清理** - 批量刪除指定範圍訊息
- **權限控制** - 基於角色的指令權限
- **日誌系統** - 完整的操作記錄
- **模組管理** - 運行時熱載入/卸載
- **指令管理** - 動態禁用/啟用指令

### 🐦 社交媒體整合
- **Twitter/X 監控** - 自動監控指定帳號新貼文
- **智能翻譯** - Google Translate API 繁體中文翻譯
- **媒體支援** - 完整抓取圖片、影片預覽
- **美觀呈現** - Discord Embed 精美顯示
- **去重機制** - 自動避免重複發送
- **調試工具** - 完整的測試和調試指令

### 🎯 用戶體驗
- **中文介面** - 完全繁體中文操作
- **直觀指令** - 簡單易記的指令設計
- **錯誤提示** - 友善的錯誤訊息和使用提示
- **互動界面** - 豐富的 Discord UI 組件
- **個人化設定** - 每個用戶的獨立配置

## 🔧 開發指南

### 環境配置
```bash
# 設定環境變數
BOT_ENV=local  # 或 prod

# 必要的環境變數
TOKEN=your_discord_bot_token
COMMAND_PREFIX=["?"]

# Twitter 監控（可選）
TWITTER_BEARER_TOKEN=your_twitter_token
GOOGLE_TRANSLATE_API_KEY=your_translate_key
```

### 開發工具
- **代碼格式化**: `black` 自動格式化
- **代碼檢查**: `flake8` 風格檢查
- **編碼規範**: 遵循 PEP 8
- **測試框架**: `pytest` 單元測試

### 部署須知
- **Python 版本**: 見 `runtime.txt`
- **支援平台**: Render、Railway、Heroku 等
- **自動埠號**: 動態埠號分配
- **健康檢查**: Flask keep_alive 端點
- **環境分離**: 本地/生產環境配置分離

### 權限需求
機器人需要以下 Discord 權限：
- **訊息管理**: 讀取、發送、刪除訊息
- **語音管理**: 建立頻道、移動成員
- **嵌入連結**: 發送 Discord Embeds
- **檔案上傳**: 發送圖片和檔案
- **使用斜線指令**: 註冊和使用應用程式指令

## 📈 技術亮點

- **異步架構** - 全面採用 async/await 模式
- **模組化設計** - 鬆耦合的 cog 系統
- **配置管理** - 環境分離的配置系統
- **錯誤處理** - 完善的異常處理機制
- **日誌記錄** - 多級別結構化日誌
- **動態管理** - 運行時模組熱載入
- **UI 組件** - 豐富的 Discord 互動元素
- **API 整合** - Twitter API、Google Translate API
- **資料持久化** - JSON 檔案系統，支援備份和恢復

## 🚨 故障排除

### 常見問題

#### Bot 無法啟動
1. 檢查 TOKEN 是否正確設定
2. 確認 Python 版本相容性
3. 檢查依賴套件是否完整安裝

#### 斜線指令不顯示
1. 使用 `?sync` 同步指令
2. 確認機器人有 `applications.commands` 權限
3. 等待 Discord 更新（最多1小時）

#### Twitter 監控失效
1. 檢查 Bearer Token 是否有效
2. 確認 API 請求額度未超限
3. 使用 `/twitter_debug` 診斷問題

#### 功能模組錯誤
1. 查看日誌輸出確認錯誤位置
2. 使用 `?rl [模組名]` 重新載入模組
3. 檢查資料檔案是否損壞

### 除錯工具
```bash
?test             # 機器人狀態測試
?logs             # 查看系統日誌
?debug            # 系統除錯資訊
/twitter_debug    # Twitter 監控診斷
/twitter_test     # API 連接測試
```

## 📋 更新日誌

### 最新更新
- ✅ **Copycat 功能增強** - 新增伺服器/主要設定智能切換
- ✅ **斜線指令支援** - 完整的 `/help` 指令列表
- ✅ **模組整合** - 移除重複功能，簡化架構
- ✅ **Twitter 監控** - 新增完整的 X 平台監控功能
- ✅ **個人化打卡** - Clock 系統完全重構

### 架構改進
- ✅ **統一配置管理** - 單例模式的配置系統
- ✅ **錯誤處理增強** - 完善的異常捕獲和日誌
- ✅ **性能優化** - 異步 I/O 和快取機制
- ✅ **代碼清理** - 移除重複和過時功能

---

**開發團隊**: yPinn  
**技術棧**: Python 3.x, discord.py, asyncio, aiohttp  
**部署**: 支援多種雲端平台  
**授權**: 開源專案  
**維護狀態**: 積極維護中